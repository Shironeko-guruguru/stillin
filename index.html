<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#000000">
  <title>still in...</title>
  <link rel="manifest" href="idk.json">
  <link rel="stylesheet" href="style.css">
  <link rel="icon" href="./images/icon-1280x1280.png" sizes="1028x1028">
  <link rel="apple-touch-icon" href="./images/icon-1280x1280.png" sizes="1028x1028">
</head>

<script>
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("/service-worker.js");
  }
</script>

<body>
  <div id="app">
    <div class="settings-container">
      <button class="settings-btn">
        <svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 -960 960 960" width="24">
          <path fill="currentColor" d="M120-240v-80h720v80H120Zm0-200v-80h720v80H120Zm0-200v-80h720v80H120Z" />
        </svg>
      </button>

      <div id="settings-menu" class="hidden">
        <button class="menu-btn" id="save-quit-btn">保存して中断</button>
        <button class="menu-btn" id="no-save-quit-btn">保存せず中断</button>
      </div>

      <div id="volume-menu" class="hidden">
        <div class="volume-control">
          <label>キャラボイス</label>
          <input type="range" min="0" max="100" value="70">
        </div>
        <div class="volume-control">
          <label>BGM</label>
          <input type="range" min="0" max="100" value="50">
        </div>
        <div class="volume-control">
          <label>システム</label>
          <input type="range" min="0" max="100" value="80">
        </div>
      </div>
    </div>

    <div class="game-header">
      <div class="status">体力: <span id="hp-value">100 / 100</span></div>
      <div class="status">残りターン: <span id="turn-value">24 / 24</span></div>
    </div>

    <div id="content">

      <div class="screen" id="main-home">
        <div class="home-content">
          <button class="home-menu-btn">ストーリー</button>
          <button class="home-menu-btn" id="goto-char-select-btn">育成</button>
        </div>
        <div class="bottom-nav">
          <button class="nav-btn">キャラ</button>
          <button class="nav-btn">タスク</button>
          <button class="nav-btn active">ホーム</button>
          <button class="nav-btn">ガチャ</button>
          <button class="nav-btn">データ</button>
        </div>
        <div id="data-menu" class="hidden">
          <button class="menu-btn" id="save-data-btn">進行状況を保存(ダウンロード)</button>
          <button class="menu-btn" id="load-data-btn">進行状況を復旧</button>
        </div>
        <input type="file" id="file-loader" class="hidden" accept=".json">
      </div>

      <div class="screen" id="char-select">
        <div class="screen-content-wrapper">
          <h2>キャラクターを選択</h2>
          <div class="char-select-container">
            <div class="char-card selected" data-char="char1">
              <p>元気な研修生</p>
            </div>
            <div class="char-card" data-char="char2">
              <p>クールな先輩</p>
            </div>
            <div class="char-card" data-char="char3">
              <p>謎の転校生</p>
            </div>
          </div>
          <button class="btn main" id="confirm-char-btn">このキャラで育成開始</button>
        </div>
      </div>

      <div class="screen" id="ikusei-home">
        <div class="screen-content-wrapper">
          <div id="parameter-bars">
            <div class="param-bar-container">
              <span class="param-label">STR</span>
              <div class="param-bar">
                <div id="str-bar" class="param-bar-fill"></div>
              </div>
              <span id="str-value" class="param-value">0</span>
            </div>
            <div class="param-bar-container">
              <span class="param-label">AGI</span>
              <div class="param-bar">
                <div id="agi-bar" class="param-bar-fill"></div>
              </div>
              <span id="agi-value" class="param-value">0</span>
            </div>
            <div class="param-bar-container">
              <span class="param-label">VIT</span>
              <div class="param-bar">
                <div id="vit-bar" class="param-bar-fill"></div>
              </div>
              <span id="vit-value" class="param-value">0</span>
            </div>
            <div class="param-bar-container">
              <span class="param-label">DEX</span>
              <div class="param-bar">
                <div id="dex-bar" class="param-bar-fill"></div>
              </div>
              <span id="dex-value" class="param-value">0</span>
            </div>
          </div>
          <div id="buff-display"></div>
        </div>
        <div class="game-footer">
          <div class="row top-row">
            <button class="btn side" id="rest-btn">お休み</button>
            <button class="btn main" onclick="showScreen('training')">トレーニング</button>
            <button class="btn side">スキル</button>
          </div>
          <div class="row bottom-row">
            <button class="btn sub">アイテム</button>
            <button class="btn sub" id="outing-btn">お出掛け</button>
          </div>
        </div>
      </div>

      <div class="screen" id="training">
        <div class="game-footer">
          <div class="row top-row">
            <button class="btn small" data-stat="str">STR</button>
            <button class="btn small" data-stat="agi">AGI</button>
            <button class="btn small" data-stat="vit">VIT</button>
            <button class="btn small" data-stat="dex">DEX</button>
          </div>
          <div class="row bottom-row">
            <button class="btn main" onclick="showScreen('ikusei-home')">もどる</button>
          </div>
        </div>
      </div>

    </div>
  </div>

  <script>
  // ===== ゲームの状態を管理するオブジェクト =====
let gameState = {};

// ===== UI更新用の要素をあらかじめ取得 =====
const hpValue = document.getElementById('hp-value');
const turnValue = document.getElementById('turn-value');
const strBar = document.getElementById('str-bar');
const agiBar = document.getElementById('agi-bar');
const vitBar = document.getElementById('vit-bar');
const dexBar = document.getElementById('dex-bar');
const strValue = document.getElementById('str-value');
const agiValue = document.getElementById('agi-value');
const vitValue = document.getElementById('vit-value');
const dexValue = document.getElementById('dex-value');
const buffDisplay = document.getElementById('buff-display');

// ===== ゲーム初期化関数 =====
function initializeGame() {
  gameState = {
    hp: 100,
    maxHp: 100,
    turn: 24,
    maxTurn: 24,
    str: 10,
    agi: 10,
    vit: 10,
    dex: 10,
    maxStat: 200, // パラメータの最大値
    trainingBuffTurns: 0, // パラメータ上昇量アップ効果の残りターン
  };
  updateUI();
  showScreen('ikusei-home');
}

// ===== UIを最新の状態に更新する関数 =====
function updateUI() {
  if (gameState.hp === undefined) return; // gameStateが未定義の場合は何もしない

  // 体力・ターンの表示更新
  hpValue.textContent = `${gameState.hp} / ${gameState.maxHp}`;
  turnValue.textContent = `${gameState.turn} / ${gameState.maxTurn}`;

  // パラメータバーの表示更新
  strBar.style.width = `${(gameState.str / gameState.maxStat) * 100}%`;
  agiBar.style.width = `${(gameState.agi / gameState.maxStat) * 100}%`;
  vitBar.style.width = `${(gameState.vit / gameState.maxStat) * 100}%`;
  dexBar.style.width = `${(gameState.dex / gameState.maxStat) * 100}%`;
  strValue.textContent = gameState.str;
  agiValue.textContent = gameState.agi;
  vitValue.textContent = gameState.vit;
  dexValue.textContent = gameState.dex;

  // 特殊効果（バフ）の表示更新
  if (gameState.trainingBuffTurns > 0) {
    buffDisplay.textContent = `パラメータ上昇量アップ中 (あと${gameState.trainingBuffTurns}ターン)`;
  } else {
    buffDisplay.textContent = '';
  }
}

// ===== 基本的な画面制御 =====
const gameHeader = document.querySelector('.game-header');
let currentScreenId = '';

function showScreen(id) {
  // 画面遷移時にデータメニューを隠す
  if (document.getElementById('data-menu')) {
    document.getElementById('data-menu').classList.add('hidden');
  }

  currentScreenId = id;

  if (id === "main-home") {
    gameHeader.style.display = "none";
  } else {
    gameHeader.style.display = "flex";
  }

  document.querySelectorAll(".screen").forEach(el => {
    el.classList.remove("active");
  });
  document.getElementById(id).classList.add("active");
}

// ===== 各ボタンのイベントリスナー =====

// 1. ホーム画面 → キャラ選択画面へ
document.getElementById('goto-char-select-btn').addEventListener('click', () => {
  showScreen('char-select');
});

// 2. キャラクター選択
document.querySelectorAll('.char-card').forEach(card => {
  card.addEventListener('click', () => {
    document.querySelector('.char-card.selected').classList.remove('selected');
    card.classList.add('selected');
  });
});

// 3. キャラクター決定 → 育成開始
document.getElementById('confirm-char-btn').addEventListener('click', () => {
  initializeGame();
});

// 4. トレーニングボタン
document.querySelectorAll('.btn.small').forEach(button => {
  button.addEventListener('click', () => {
    if (gameState.turn <= 0) return; // ターンがなければ何もしない

    const statType = button.dataset.stat;
    const hpPercent = gameState.hp / gameState.maxHp;
    let baseGain = 10;

    // 体力によるパラメータ上昇量の変動
    if (hpPercent < 0.4) baseGain *= 0.6; // 体力が40%未満なら効率ダウン
    if (hpPercent > 0.8) baseGain *= 1.4; // 体力が80%以上なら効率アップ

    // お出掛けによる特殊効果
    if (gameState.trainingBuffTurns > 0) {
      baseGain *= 1.5; // 上昇量1.5倍
    }

    // ターンと特殊効果の消費
    gameState.turn--;
    if (gameState.trainingBuffTurns > 0) gameState.trainingBuffTurns--;

    // パラメータと体力を更新
    gameState[statType] = Math.min(gameState.maxStat, gameState[statType] + Math.round(baseGain));
    gameState.hp = Math.max(0, gameState.hp - 15);

    updateUI();
    showScreen('ikusei-home');
  });
});

// 5. お休みボタン
document.getElementById('rest-btn').addEventListener('click', () => {
  if (gameState.turn <= 0) return;
  gameState.turn--;
  if (gameState.trainingBuffTurns > 0) gameState.trainingBuffTurns--;

  const recovery = 70; // 回復量
  gameState.hp = Math.min(gameState.maxHp, gameState.hp + recovery);
  updateUI();
});

// 6. お出掛けボタン
document.getElementById('outing-btn').addEventListener('click', () => {
  if (gameState.turn <= 0) return;
  gameState.turn--;

  const recovery = 30; // お休みより回復量は少ない
  gameState.hp = Math.min(gameState.maxHp, gameState.hp + recovery);
  gameState.trainingBuffTurns = 5; // 5ターンの間、特殊効果を付与
  updateUI();
});


// ===== ハンバーガーメニュー制御 =====
const settingsBtn = document.querySelector('.settings-btn');
const settingsMenu = document.getElementById('settings-menu');
const volumeMenu = document.getElementById('volume-menu');

settingsBtn.addEventListener('click', () => {
  if (currentScreenId === 'main-home') {
    volumeMenu.classList.toggle('hidden');
    settingsMenu.classList.add('hidden');
  } else {
    settingsMenu.classList.toggle('hidden');
    volumeMenu.classList.add('hidden');
  }
});

const saveQuitBtn = document.getElementById('save-quit-btn');
const noSaveQuitBtn = document.getElementById('no-save-quit-btn');

saveQuitBtn.addEventListener('click', () => {
  showScreen('main-home');
  settingsMenu.classList.add('hidden');
});

noSaveQuitBtn.addEventListener('click', () => {
  const isConfirmed = confirm("本当に保存しないで中断しますか？\n（この操作は取り消せません）");
  if (isConfirmed) {
    showScreen('main-home');
    settingsMenu.classList.add('hidden');
  }
});

// ===== データ連携機能 =====
const dataMenu = document.getElementById('data-menu');
const dataBtn = document.getElementById('data-btn');
const saveDataBtn = document.getElementById('save-data-btn');
const loadDataBtn = document.getElementById('load-data-btn');
const fileLoader = document.getElementById('file-loader');

// 「データ」ボタンでメニューの表示/非表示
dataBtn.addEventListener('click', (event) => {
  event.stopPropagation(); // イベントが親要素に伝播するのを防ぐ
  dataMenu.classList.toggle('hidden');
});

// 「保存」ボタンの処理
saveDataBtn.addEventListener('click', () => {
  if (Object.keys(gameState).length === 0) {
    alert("保存できる進行状況がありません。");
    return;
  }
  // gameStateをJSON文字列に変換
  const dataStr = JSON.stringify(gameState, null, 2);
  // Blobオブジェクトを作成
  const blob = new Blob([dataStr], {
    type: "application/json"
  });
  // ダウンロード用のURLを生成
  const url = URL.createObjectURL(blob);

  const a = document.createElement('a');
  a.href = url;
  a.download = `game-save-${new Date().toISOString().slice(0, 10)}.json`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url); // メモリを解放

  dataMenu.classList.add('hidden');
});

// 「復旧」ボタンの処理
loadDataBtn.addEventListener('click', () => {
  fileLoader.click(); // 非表示のinput要素をクリックさせる
  dataMenu.classList.add('hidden');
});

// ファイルが選択されたときの処理
fileLoader.addEventListener('change', (event) => {
  const file = event.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = (e) => {
    try {
      const restoredState = JSON.parse(e.target.result);
      // 簡単なバリデーション
      if (restoredState.hp !== undefined && restoredState.turn !== undefined) {
        gameState = restoredState;
        updateUI();
        showScreen('ikusei-home'); // 復旧後、育成画面に遷移
        alert("進行状況を復旧しました。");
      } else {
        throw new Error("無効なセーブデータです。");
      }
    } catch (error) {
      alert("ファイルの読み込みに失敗しました。\n" + error.message);
    }
  };
  reader.readAsText(file);
  event.target.value = ''; // 同じファイルを連続で選択できるように値をリセット
});

// メニューの外側をクリックしたらメニューを閉じる
document.body.addEventListener('click', () => {
  dataMenu.classList.add('hidden');
});

// ===== 初期画面の設定 =====
showScreen("main-home");
  </script>
</body>
</html>