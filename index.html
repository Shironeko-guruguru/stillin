<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#000000">
  <title>still in...</title>
  <link rel="manifest" href="idk.json">
  <link rel="stylesheet" href="style.css">
  <link rel="icon" href="./images/icon-1280x1280.png" sizes="1028x1028">
  <link rel="apple-touch-icon" href="./images/icon-1280x1280.png" sizes="1028x1028">
</head>

<body>
  <div id="app">
    <div class="settings-container">
      <button class="settings-btn">
        <svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 -960 960 960" width="24">
          <path fill="currentColor" d="M120-240v-80h720v80H120Zm0-200v-80h720v80H120Zm0-200v-80h720v80H120Z" />
        </svg>
      </button>

      <div id="settings-menu" class="hidden">
        <button class="menu-btn" id="save-quit-btn">保存して中断</button>
        <button class="menu-btn" id="no-save-quit-btn">保存せず中断</button>
      </div>

      <div id="volume-menu" class="hidden">
        <div class="volume-control">
          <label>キャラボイス</label>
          <input type="range" min="0" max="100" value="70">
        </div>
        <div class="volume-control">
          <label>BGM</label>
          <input type="range" min="0" max="100" value="50">
        </div>
        <div class="volume-control">
          <label>システム</label>
          <input type="range" min="0" max="100" value="80">
        </div>
      </div>
    </div>

    <div class="game-header">
      <div class="status">体力: <span id="hp-value">100 / 100</span></div>
      <div class="status">残りターン: <span id="turn-value">24 / 24</span></div>
    </div>

    <div id="content">
      <div class="screen" id="main-home">
        <div class="home-content">
          <button class="home-menu-btn">ストーリー</button>
          <button class="home-menu-btn" id="goto-char-select-btn">育成</button>
        </div>
        <div class="bottom-nav">
          <button class="nav-btn">キャラ</button>
          <button class="nav-btn">タスク</button>
          <button class="nav-btn active">ホーム</button>
          <button class="nav-btn">ガチャ</button>
          <button class="nav-btn" id="data-btn">データ</button>
        </div>
      </div>

      <div class="screen" id="char-select">
        <div class="screen-content-wrapper">
          <h2>キャラクターを選択</h2>
          <div class="char-select-container">
            <div class="char-card selected" data-char="char1">
              <p>元気な研修生</p>
            </div>
            <div class="char-card" data-char="char2">
              <p>クールな先輩</p>
            </div>
            <div class="char-card" data-char="char3">
              <p>謎の転校生</p>
            </div>
          </div>
          <button class="btn main" id="confirm-char-btn">このキャラで育成開始</button>
        </div>
      </div>

      <div class="screen" id="ikusei-home">
        <div class="screen-content-wrapper">
          <div id="parameter-bars">
            <div class="param-bar-container">
              <span class="param-label">STR</span>
              <div class="param-bar">
                <div id="str-bar" class="param-bar-fill"></div>
              </div>
              <span id="str-value" class="param-value">0</span>
            </div>
            <div class="param-bar-container">
              <span class="param-label">AGI</span>
              <div class="param-bar">
                <div id="agi-bar" class="param-bar-fill"></div>
              </div>
              <span id="agi-value" class="param-value">0</span>
            </div>
            <div class="param-bar-container">
              <span class="param-label">VIT</span>
              <div class="param-bar">
                <div id="vit-bar" class="param-bar-fill"></div>
              </div>
              <span id="vit-value" class="param-value">0</span>
            </div>
            <div class="param-bar-container">
              <span class="param-label">DEX</span>
              <div class="param-bar">
                <div id="dex-bar" class="param-bar-fill"></div>
              </div>
              <span id="dex-value" class="param-value">0</span>
            </div>
          </div>
          <div id="buff-display"></div>
        </div>
        <div class="game-footer">
          <div class="row top-row">
            <button class="btn side" id="rest-btn">お休み</button>
            <button class="btn main" onclick="showScreen('training')">トレーニング</button>
            <button class="btn side">スキル</button>
          </div>
          <div class="row bottom-row">
            <button class="btn sub">アイテム</button>
            <button class="btn sub" id="outing-btn">お出掛け</button>
          </div>
        </div>
      </div>

      <div class="screen" id="training">
        <div class="game-footer">
          <div class="row top-row">
            <button class="btn small" data-stat="str">STR</button>
            <button class="btn small" data-stat="agi">AGI</button>
            <button class="btn small" data-stat="vit">VIT</button>
            <button class="btn small" data-stat="dex">DEX</button>
          </div>
          <div class="row bottom-row">
            <button class="btn main" onclick="showScreen('ikusei-home')">もどる</button>
          </div>
        </div>
      </div>
    </div>

    <div id="data-menu" class="hidden">
      <button class="menu-btn" id="save-data-btn">進行状況を保存(ダウンロード)</button>
      <button class="menu-btn" id="load-data-btn">進行状況を復旧</button>
    </div>
    <input type="file" id="file-loader" class="hidden" accept=".json">

  </div>
<script>
    // ===== ゲームの状態を管理するオブジェクト =====
let gameState = {};

// ===== UI更新用の要素をあらかじめ取得 =====
const hpValue = document.getElementById('hp-value');
const turnValue = document.getElementById('turn-value');
const strBar = document.getElementById('str-bar');
const agiBar = document.getElementById('agi-bar');
const vitBar = document.getElementById('vit-bar');
const dexBar = document.getElementById('dex-bar');
const strValue = document.getElementById('str-value');
const agiValue = document.getElementById('agi-value');
const vitValue = document.getElementById('vit-value');
const dexValue = document.getElementById('dex-value');
const buffDisplay = document.getElementById('buff-display');

// ===== ゲーム初期化関数 =====
function initializeGame() {
  localStorage.removeItem('savedGame');

  gameState = {
    hp: 100,
    maxHp: 100,
    turn: 24,
    maxTurn: 24,
    str: 10,
    agi: 10,
    vit: 10,
    dex: 10,
    maxStat: 200,
    trainingBuffTurns: 0,
  };
  updateUI();
  showScreen('ikusei-home');
}

// ===== UIを最新の状態に更新する関数 =====
function updateUI() {
  if (gameState.hp === undefined) return;

  hpValue.textContent = `${gameState.hp} / ${gameState.maxHp}`;
  turnValue.textContent = `${gameState.turn} / ${gameState.maxTurn}`;

  strBar.style.width = `${(gameState.str / gameState.maxStat) * 100}%`;
  agiBar.style.width = `${(gameState.agi / gameState.maxStat) * 100}%`;
  vitBar.style.width = `${(gameState.vit / gameState.maxStat) * 100}%`;
  dexBar.style.width = `${(gameState.dex / gameState.maxStat) * 100}%`;
  strValue.textContent = gameState.str;
  agiValue.textContent = gameState.agi;
  vitValue.textContent = gameState.vit;
  dexValue.textContent = gameState.dex;

  if (gameState.trainingBuffTurns > 0) {
    buffDisplay.textContent = `パラメータ上昇量アップ中 (あと${gameState.trainingBuffTurns}ターン)`;
  } else {
    buffDisplay.textContent = '';
  }
}

// ===== 基本的な画面制御 =====
const gameHeader = document.querySelector('.game-header');
let currentScreenId = '';

function showScreen(id) {
  if (document.getElementById('data-menu')) {
    document.getElementById('data-menu').classList.add('hidden');
  }
  currentScreenId = id;
  if (id === "main-home") {
    gameHeader.style.display = "none";
  } else {
    gameHeader.style.display = "flex";
  }
  document.querySelectorAll(".screen").forEach(el => {
    el.classList.remove("active");
  });
  document.getElementById(id).classList.add("active");
}

// ===== 各ボタンのイベントリスナー =====

document.getElementById('goto-char-select-btn').addEventListener('click', () => {
  const savedData = localStorage.getItem('savedGame');
  if (savedData) {
    gameState = JSON.parse(savedData);
    updateUI();
    showScreen('ikusei-home');
  } else {
    showScreen('char-select');
  }
});

document.querySelectorAll('.char-card').forEach(card => {
  card.addEventListener('click', () => {
    document.querySelector('.char-card.selected').classList.remove('selected');
    card.classList.add('selected');
  });
});

document.getElementById('confirm-char-btn').addEventListener('click', () => {
  initializeGame();
});

document.querySelectorAll('.btn.small').forEach(button => {
  button.addEventListener('click', () => {
    if (gameState.turn <= 0) return;
    const statType = button.dataset.stat;
    const hpPercent = gameState.hp / gameState.maxHp;
    let baseGain = 10;
    if (hpPercent < 0.4) baseGain *= 0.6;
    if (hpPercent > 0.8) baseGain *= 1.4;
    if (gameState.trainingBuffTurns > 0) baseGain *= 1.5;
    gameState.turn--;
    if (gameState.trainingBuffTurns > 0) gameState.trainingBuffTurns--;
    gameState[statType] = Math.min(gameState.maxStat, gameState[statType] + Math.round(baseGain));
    gameState.hp = Math.max(0, gameState.hp - 15);
    updateUI();
    showScreen('ikusei-home');
  });
});

document.getElementById('rest-btn').addEventListener('click', () => {
  if (gameState.turn <= 0) return;
  gameState.turn--;
  if (gameState.trainingBuffTurns > 0) gameState.trainingBuffTurns--;
  const recovery = 70;
  gameState.hp = Math.min(gameState.maxHp, gameState.hp + recovery);
  updateUI();
});

document.getElementById('outing-btn').addEventListener('click', () => {
  if (gameState.turn <= 0) return;
  gameState.turn--;
  const recovery = 30;
  gameState.hp = Math.min(gameState.maxHp, gameState.hp + recovery);
  gameState.trainingBuffTurns = 5;
  updateUI();
});

// ===== ハンバーガーメニュー制御 =====
const settingsBtn = document.querySelector('.settings-btn');
const settingsMenu = document.getElementById('settings-menu');
const volumeMenu = document.getElementById('volume-menu');

settingsBtn.addEventListener('click', () => {
  if (currentScreenId === 'main-home') {
    volumeMenu.classList.toggle('hidden');
    settingsMenu.classList.add('hidden');
  } else {
    settingsMenu.classList.toggle('hidden');
    volumeMenu.classList.add('hidden');
  }
});

const saveQuitBtn = document.getElementById('save-quit-btn');
const noSaveQuitBtn = document.getElementById('no-save-quit-btn');

saveQuitBtn.addEventListener('click', () => {
  localStorage.setItem('savedGame', JSON.stringify(gameState));
  showScreen('main-home');
  settingsMenu.classList.add('hidden');
});

noSaveQuitBtn.addEventListener('click', () => {
  const isConfirmed = confirm("本当に保存しないで中断しますか？\n（この操作は取り消せません）");
  if (isConfirmed) {
    localStorage.removeItem('savedGame');
    showScreen('main-home');
    settingsMenu.classList.add('hidden');
  }
});

// ===== データ連携機能 =====
const dataMenu = document.getElementById('data-menu');
const dataBtn = document.getElementById('data-btn');
const saveDataBtn = document.getElementById('save-data-btn');
const loadDataBtn = document.getElementById('load-data-btn');
const fileLoader = document.getElementById('file-loader');

dataBtn.addEventListener('click', (event) => {
  event.stopPropagation();
  dataMenu.classList.toggle('hidden');
});

saveDataBtn.addEventListener('click', () => {
  const activeGameState = localStorage.getItem('savedGame');
  const dataToSave = activeGameState ? JSON.parse(activeGameState) : gameState;
  if (Object.keys(dataToSave).length === 0) {
    alert("保存できる進行状況がありません。");
    return;
  }
  const dataStr = JSON.stringify(dataToSave, null, 2);
  const blob = new Blob([dataStr], { type: "application/json" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `game-save-${new Date().toISOString().slice(0, 10)}.json`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  dataMenu.classList.add('hidden');
});

loadDataBtn.addEventListener('click', () => {
  fileLoader.click();
  dataMenu.classList.add('hidden');
});

fileLoader.addEventListener('change', (event) => {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (e) => {
    try {
      const restoredState = JSON.parse(e.target.result);
      if (restoredState.hp !== undefined && restoredState.turn !== undefined) {
        gameState = restoredState;
        localStorage.setItem('savedGame', JSON.stringify(gameState));
        updateUI();
        showScreen('ikusei-home');
        alert("進行状況を復旧しました。");
      } else {
        throw new Error("無効なセーブデータです。");
      }
    } catch (error) {
      alert("ファイルの読み込みに失敗しました。\n" + error.message);
    }
  };
  reader.readAsText(file);
  event.target.value = '';
});

document.body.addEventListener('click', () => {
  dataMenu.classList.add('hidden');
});

// ===== 初期画面の設定 =====
showScreen("main-home");
</script>
</body>

</html>